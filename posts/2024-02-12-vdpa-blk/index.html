<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>vDPA: support for block devices in Linux and QEMU - Virtualization and networking blog</title>

  <meta name="description" content="Using libblkio, QEMU Storage Daemon, and VDUSE">
  <meta name="author" content="Stefano Garzarella"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "sgarzare\u0027s blog",
    
    "url": "https:\/\/stefano-garzarella.github.io"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/stefano-garzarella.github.io"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/stefano-garzarella.github.io",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/stefano-garzarella.github.io\/posts\/2024-02-12-vdpa-blk\/",
          "name": "V dpa support for block devices in linux and qemu"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Stefano Garzarella"
  },
  "headline": "vDPA: support for block devices in Linux and QEMU",
  "description" : "A vDPA device is a type of device that follows the virtio specification for its datapath but has a vendor-specific control path.\nvDPA devices can be both physically located on the hardware or emulated by software.\nA small vDPA parent driver in the host kernel is required only for the control path. The main advantage is the unified software stack for all vDPA devices:\nvhost interface (vhost-vdpa) for userspace or guest virtio driver, like a VM running in QEMU virtio interface (virtio-vdpa) for bare-metal or containerized applications running in the host management interface (vdpa netlink) for instantiating devices and configuring virtio parameters ",
  "inLanguage" : "en",
  "wordCount":  1472 ,
  "datePublished" : "2024-02-12T18:42:57",
  "dateModified" : "2024-02-12T18:42:57",
  "image" : "https:\/\/stefano-garzarella.github.io\/img\/avatar-icon.jpg",
  "keywords" : [ "virtio, vdpa, vduse, linux, qemu, conference, talk" ],
  "mainEntityOfPage" : "https:\/\/stefano-garzarella.github.io\/posts\/2024-02-12-vdpa-blk\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/stefano-garzarella.github.io",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/stefano-garzarella.github.io\/img\/avatar-icon.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="vDPA: support for block devices in Linux and QEMU" />
<meta property="og:description" content="Using libblkio, QEMU Storage Daemon, and VDUSE">
<meta property="og:image" content="https://stefano-garzarella.github.io/img/avatar-icon.jpg" />
<meta property="og:url" content="https://stefano-garzarella.github.io/posts/2024-02-12-vdpa-blk/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="sgarzare&#39;s blog" />

  <meta name="twitter:title" content="vDPA: support for block devices in Linux and QEMU" />
  <meta name="twitter:description" content="Using libblkio, QEMU Storage Daemon, and VDUSE">
  <meta name="twitter:image" content="https://stefano-garzarella.github.io/img/avatar-icon.jpg" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@sgarzarella" />
  <meta name="twitter:creator" content="@sgarzarella" />
  <link href='https://stefano-garzarella.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.111.3">
  <link rel="alternate" href="https://stefano-garzarella.github.io/index.xml" type="application/rss+xml" title="sgarzare&#39;s blog"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="https://stefano-garzarella.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://stefano-garzarella.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://stefano-garzarella.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-146409373-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://stefano-garzarella.github.io">sgarzare&#39;s blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Home" href="/">Home</a>
            </li>
          
        
          
            <li>
              <a title="Posts" href="/posts">Posts</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">Search</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="sgarzare&#39;s blog" href="https://stefano-garzarella.github.io">
            <img class="avatar-img" src="https://stefano-garzarella.github.io/img/avatar-icon.jpg" alt="sgarzare&#39;s blog" />
          </a>
        </div>
      </div>
    

  </div>
</nav>



  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search sgarzare&#39;s blog</h4>
        </div>
        <div class="modal-body">
          <gcse:search></gcse:search>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>vDPA: support for block devices in Linux and QEMU</h1>
              
              
              
                
                  <h2 class="post-subheading">Using libblkio, QEMU Storage Daemon, and VDUSE</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on 2024/02/12
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;7&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;1472&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Stefano Garzarella
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>A <em>vDPA device</em> is a type of device that follows the <strong><a href="https://docs.oasis-open.org/virtio/virtio/v1.3/virtio-v1.3.html">virtio specification</a>
for its datapath</strong> but has a <strong>vendor-specific control path</strong>.</p>
<p>vDPA devices can be both physically located on the hardware or emulated by
software.</p>
<p><img src="/img/vdpa_overview.png" alt="vDPA overview"></p>
<p>A small vDPA parent driver in the host kernel is required only for the control
path. The main advantage is the <strong>unified software stack</strong> for all vDPA
devices:</p>
<ul>
<li><em>vhost interface</em> (vhost-vdpa) for userspace or guest virtio driver, like a
VM running in QEMU</li>
<li><em>virtio interface</em> (virtio-vdpa) for bare-metal or containerized applications
running in the host</li>
<li><em>management interface</em> (vdpa netlink) for instantiating devices and
configuring virtio parameters</li>
</ul>
<h3 id="useful-resources">Useful Resources</h3>
<p>Many blog posts and talks have been published in recent years that can help you
better understand vDPA and the use cases. On <a href="https://vdpa-dev.gitlab.io/">vdpa-dev.gitlab.io</a>
we collected some of them; I suggest you at least explore the following:</p>
<ul>
<li><a href="https://www.redhat.com/en/blog/introduction-vdpa-kernel-framework">Introduction to vDPA kernel framework</a></li>
<li><a href="https://www.redhat.com/en/blog/introducing-vduse-software-defined-datapath-virtio">Introducing VDUSE: a software-defined datapath for virtio</a></li>
</ul>
<h2 id="block-devices">Block devices</h2>
<p>Most of the work in vDPA has been driven by network devices, but in recent years,
we have also developed support for block devices.</p>
<p>The main use case is definitely leveraging the hardware to directly emulate the
virtio-blk device and support different network backends such as Ceph RBD or
iSCSI. This is the goal of some SmartNICs or DPUs, which are able to emulate
virtio-net devices of course, but also virtio-blk for network storage.</p>
<p>The abstraction provided by vDPA also makes software accelerators possible,
similar to existing vhost or vhost-user devices.
<a href="https://kvmforum2021.sched.com/event/ke3a/vdpa-blk-unified-hardware-and-software-offload-for-virtio-blk-stefano-garzarella-red-hat">We discussed about that at KVM Forum 2021</a>.</p>
<p>We talked about the fast path and the slow path in that talk. When QEMU needs
to handle requests, like supporting live migration or executing I/O throttling,
it uses the slow path. During the slow path, the device exposed to the guest is
emulated in QEMU. QEMU intercepts the requests and forwards them to the vDPA
device by taking advantage of the driver implemented in libblkio.
On the other hand, when QEMU doesn&rsquo;t need to intervene, the fast path comes
into play. In this case, the vDPA device can be directly exposed to the guest,
bypassing QEMU&rsquo;s emulation.</p>
<p><a href="https://gitlab.com/libblkio/libblkio">libblkio</a> exposes common API for accessing
block devices in userspace. It supports several drivers. We will focus more
on <code>virtio-blk-vhost-vdpa</code> driver, which is used by <code>virtio-blk-vhost-vdpa</code>
block device in QEMU. It only supports slow path for now, but in the future
it should be able to switch to fast path automatically. Since QEMU 7.2, it
supports libblkio drivers, so you can use the following options to attach a
vDPA block device to a VM:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">   -blockdev node-name<span class="o">=</span>drive_src1,driver<span class="o">=</span>virtio-blk-vhost-vdpa,path<span class="o">=</span>/dev/vhost-vdpa-0,cache.direct<span class="o">=</span>on <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>   -device virtio-blk-pci,id<span class="o">=</span>src1,bootindex<span class="o">=</span>2,drive<span class="o">=</span>drive_src1 <span class="se">\
</span></span></span></code></pre></div><p>Anyway, to fully leverage the performance of a vDPA hardware device, we can
always use the generic <code>vhost-vdpa-device-pci</code> device offered by QEMU that
supports any vDPA device and exposes it directly to the guest. Of course,
QEMU is not able to intercept requests in this scenario and therefore some
features offered by its block layer (e.g. live migration, disk format, etc.)
are not supported. Since QEMU 8.0, you can use the following options to attach
a generic vDPA device to a VM:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">    -device vhost-vdpa-device-pci,vhostdev<span class="o">=</span>/dev/vhost-vdpa-0
</span></span></code></pre></div><p>At KVM Forum 2022, <a href="https://kvmforum2022.sched.com/event/15jLs/introducing-the-libblkio-high-performance-block-io-api-stefan-hajnoczi-alberto-faria-red-hat">Alberto Faria and Stefan Hajnoczi introduced libblkio</a>,
while <a href="https://kvmforum2022.sched.com/event/15jK5/qemu-storage-daemon-and-libblkio-exploring-new-shores-for-the-qemu-block-layer-kevin-wolf-stefano-garzarella-red-hat">Kevin Wolf and I discussed its usage in the QEMU Storage Deamon (QSD)</a>.</p>
<h2 id="software-devices">Software devices</h2>
<p>One of the significant benefits of vDPA is its strong abstraction, enabling
the implementation of virtio devices in both hardware and software—whether in
the kernel or user space. This unification under a single framework, where
devices appear identical for QEMU facilitates the seamless integration of
hardware and software components.</p>
<h3 id="kernel-devices">Kernel devices</h3>
<p>Regarding in-kernel devices, starting from Linux v5.13, there exists a simple
simulator designed for development and debugging purposes. It is available
through the <code>vdpa-sim-blk</code> kernel module, which emulates a 128 MB ramdisk.
As highlighted in the presentation at KVM Forum 2021, a future device in the
kernel (similar to the repeatedly proposed but never merged <code>vhost-blk</code>)
could potentially offer excellent performance. Such a device could be used
as an alternative when hardware is unavailable, for instance, facilitating
live migration in any system, regardless of whether the destination system
features a SmartNIC/DPU or not.</p>
<h3 id="user-space-devices">User space devices</h3>
<p>Instead, regarding user space, we can use VDUSE. QSD supports it and thus
allows us to export any disk image supported by QEMU, such as a vDPA device
in this way:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">qemu-storage-daemon <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --blockdev file,filename<span class="o">=</span>/path/to/disk.qcow2,node-name<span class="o">=</span>file <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --blockdev qcow2,file<span class="o">=</span>file,node-name<span class="o">=</span>qcow2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --export <span class="nv">type</span><span class="o">=</span>vduse-blk,id<span class="o">=</span>vduse0,name<span class="o">=</span>vduse0,node-name<span class="o">=</span>qcow2,writable<span class="o">=</span>on
</span></span></code></pre></div><h2 id="containers-vms-or-bare-metal">Containers, VMs, or bare-metal</h2>
<p>As mentioned in the introduction, vDPA supports different buses such as
<code>vhost-vdpa</code> and <code>virtio-vdpa</code>. This flexibility enables the utilization of
vDPA devices with virtual machines or user space drivers (e.g., libblkio)
through the <code>vhost-vdpa</code> bus. Additionally, it allows interaction with
applications running directly on the host or within containers via the
<code>virtio-vdpa</code> bus.</p>
<p>The <code>vdpa</code> tool in iproute2 facilitates the management of vdpa devices
through netlink, enabling the allocation and deallocation of these devices.</p>
<p>Starting with Linux 5.17, vDPA drivers support <code>driver_ovveride</code>. This
enhancement allows dynamic reconfiguration during runtime, permitting the
migration of a device from one bus to another in this way:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># load vdpa buses</span>
</span></span><span class="line"><span class="cl">$ modprobe -a virtio-vdpa vhost-vdpa
</span></span><span class="line"><span class="cl"><span class="c1"># load vdpa-blk in-kernel simulator</span>
</span></span><span class="line"><span class="cl">$ modprobe vdpa-sim-blk
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># instantiate a new vdpasim_blk device called `vdpa0`</span>
</span></span><span class="line"><span class="cl">$ vdpa dev add mgmtdev vdpasim_blk name vdpa0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># `vdpa0` is attached to the first vDPA bus driver loaded</span>
</span></span><span class="line"><span class="cl">$ driverctl -b vdpa list-devices
</span></span><span class="line"><span class="cl">vdpa0 virtio_vdpa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># change the `vdpa0` bus to `vhost-vdpa`</span>
</span></span><span class="line"><span class="cl">$ driverctl -b vdpa set-override vdpa0 vhost_vdpa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># `vdpa0` is now attached to the `vhost-vdpa` bus</span>
</span></span><span class="line"><span class="cl">$ driverctl -b vdpa list-devices
</span></span><span class="line"><span class="cl">vdpa0 vhost_vdpa <span class="o">[</span>*<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Note: driverctl(8) integrates with udev so the binding is preserved.</span>
</span></span></code></pre></div><h2 id="examples">Examples</h2>
<p>Below are several examples on how to use <em>VDUSE</em> and the <em>QEMU Storage Daemon</em>
with VMs (<code>QEMU</code>) or Containers (<code>podman</code>).
These steps are easily adaptable to any hardware that supports virtio-blk
devices via vDPA.</p>
<h3 id="qcow2-image-available-for-host-applications-and-containers">qcow2 image available for host applications and containers</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># load vdpa buses</span>
</span></span><span class="line"><span class="cl">$ modprobe -a virtio-vdpa vhost-vdpa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># create an empty qcow2 image</span>
</span></span><span class="line"><span class="cl">$ qemu-img create -f qcow2 test.qcow2 10G
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># load vduse kernel module</span>
</span></span><span class="line"><span class="cl">$ modprobe vduse
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># launch QSD exposing the `test.qcow2` image as `vduse0` vDPA device</span>
</span></span><span class="line"><span class="cl">$ qemu-storage-daemon --blockdev file,filename<span class="o">=</span>test.qcow2,node-name<span class="o">=</span>file <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --blockdev qcow2,file<span class="o">=</span>file,node-name<span class="o">=</span>qcow2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --export vduse-blk,id<span class="o">=</span>vduse0,name<span class="o">=</span>vduse0,num-queues<span class="o">=</span>1,node-name<span class="o">=</span>qcow2,writable<span class="o">=</span>on <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># instantiate the `vduse0` device (same name used in QSD)</span>
</span></span><span class="line"><span class="cl">$ vdpa dev add name vduse0 mgmtdev vduse
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># be sure to attach it to the `virtio-vdpa` device to use with host applications</span>
</span></span><span class="line"><span class="cl">$ driverctl -b vdpa set-override vduse0 virtio_vdpa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># device exposed as a virtio device, but attached to the host kernel</span>
</span></span><span class="line"><span class="cl">$ lsblk -pv
</span></span><span class="line"><span class="cl">NAME     TYPE TRAN   SIZE RQ-SIZE  MQ
</span></span><span class="line"><span class="cl">/dev/vda disk virtio  10G     <span class="m">256</span>   <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># start a container with `/dev/vda` attached</span>
</span></span><span class="line"><span class="cl">podman run -it --rm --device /dev/vda --group-add keep-groups fedora:39 bash
</span></span></code></pre></div><h3 id="launch-a-vm-using-a-vdpa-device">Launch a VM using a vDPA device</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># download Fedora cloud image (or use any other bootable image you want)</span>
</span></span><span class="line"><span class="cl">$ wget https://download.fedoraproject.org/pub/fedora/linux/releases/39/Cloud/x86_64/images/Fedora-Cloud-Base-39-1.5.x86_64.qcow2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># launch QSD exposing the VM image as `vduse1` vDPA device</span>
</span></span><span class="line"><span class="cl">$ qemu-storage-daemon <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --blockdev file,filename<span class="o">=</span>Fedora-Cloud-Base-39-1.5.x86_64.qcow2,node-name<span class="o">=</span>file <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --blockdev qcow2,file<span class="o">=</span>file,node-name<span class="o">=</span>qcow2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --export vduse-blk,id<span class="o">=</span>vduse1,name<span class="o">=</span>vduse1,num-queues<span class="o">=</span>1,node-name<span class="o">=</span>qcow2,writable<span class="o">=</span>on <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># instantiate the `vduse1` device (same name used in QSD)</span>
</span></span><span class="line"><span class="cl">$ vdpa dev add name vduse1 mgmtdev vduse
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># initially it&#39;s attached to the host (`/dev/vdb`), because `virtio-vdpa`</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is the first kernel module we loaded</span>
</span></span><span class="line"><span class="cl">$ lsblk -pv
</span></span><span class="line"><span class="cl">NAME     TYPE TRAN   SIZE RQ-SIZE  MQ
</span></span><span class="line"><span class="cl">/dev/vda disk virtio  10G     <span class="m">256</span>   <span class="m">1</span>
</span></span><span class="line"><span class="cl">/dev/vdb disk virtio   5G     <span class="m">256</span>   <span class="m">1</span>
</span></span><span class="line"><span class="cl">$ lsblk /dev/vdb
</span></span><span class="line"><span class="cl">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
</span></span><span class="line"><span class="cl">vdb    251:16   <span class="m">0</span>    5G  <span class="m">0</span> disk 
</span></span><span class="line"><span class="cl">├─vdb1 251:17   <span class="m">0</span>    1M  <span class="m">0</span> part 
</span></span><span class="line"><span class="cl">├─vdb2 251:18   <span class="m">0</span> 1000M  <span class="m">0</span> part 
</span></span><span class="line"><span class="cl">├─vdb3 251:19   <span class="m">0</span>  100M  <span class="m">0</span> part 
</span></span><span class="line"><span class="cl">├─vdb4 251:20   <span class="m">0</span>    4M  <span class="m">0</span> part 
</span></span><span class="line"><span class="cl">└─vdb5 251:21   <span class="m">0</span>  3.9G  <span class="m">0</span> part 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># and it is identified as `virtio1` in the host</span>
</span></span><span class="line"><span class="cl">$ ls /sys/bus/vdpa/devices/vduse1/
</span></span><span class="line"><span class="cl">driver  driver_override  power  subsystem  uevent  virtio1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># attach it to the `vhost-vdpa` device to use the device with VMs</span>
</span></span><span class="line"><span class="cl">$ driverctl -b vdpa set-override vduse1 vhost_vdpa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># `/dev/vdb` is not available anymore</span>
</span></span><span class="line"><span class="cl">$ lsblk -pv
</span></span><span class="line"><span class="cl">NAME     TYPE TRAN   SIZE RQ-SIZE  MQ
</span></span><span class="line"><span class="cl">/dev/vda disk virtio  10G     <span class="m">256</span>   <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># the device is identified as `vhost-vdpa-1` in the host</span>
</span></span><span class="line"><span class="cl">$ ls /sys/bus/vdpa/devices/vduse1/
</span></span><span class="line"><span class="cl">driver  driver_override  power  subsystem  uevent  vhost-vdpa-1
</span></span><span class="line"><span class="cl">$ ls -l /dev/vhost-vdpa-1
</span></span><span class="line"><span class="cl">crw-------. <span class="m">1</span> root root 511, <span class="m">0</span> Feb <span class="m">12</span> 17:58 /dev/vhost-vdpa-1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># launch QEMU using `/dev/vhost-vdpa-1` device with the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># `virtio-blk-vhost-vdpa` libblkio driver</span>
</span></span><span class="line"><span class="cl">$ qemu-system-x86_64 -m 512M -smp <span class="m">2</span> -M q35,accel<span class="o">=</span>kvm,memory-backend<span class="o">=</span>mem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -object memory-backend-memfd,share<span class="o">=</span>on,id<span class="o">=</span>mem,size<span class="o">=</span><span class="s2">&#34;512M&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -blockdev node-name<span class="o">=</span>drive0,driver<span class="o">=</span>virtio-blk-vhost-vdpa,path<span class="o">=</span>/dev/vhost-vdpa-1,cache.direct<span class="o">=</span>on <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-blk-pci,drive<span class="o">=</span>drive0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># `virtio-blk-vhost-vdpa` blockdev can be used with any QEMU block layer</span>
</span></span><span class="line"><span class="cl"><span class="c1"># features (e.g live migration, I/O throttling).</span>
</span></span><span class="line"><span class="cl"><span class="c1"># In this example we are using I/O throttling:</span>
</span></span><span class="line"><span class="cl">$ qemu-system-x86_64 -m 512M -smp <span class="m">2</span> -M q35,accel<span class="o">=</span>kvm,memory-backend<span class="o">=</span>mem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -object memory-backend-memfd,share<span class="o">=</span>on,id<span class="o">=</span>mem,size<span class="o">=</span><span class="s2">&#34;512M&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -blockdev node-name<span class="o">=</span>drive0,driver<span class="o">=</span>virtio-blk-vhost-vdpa,path<span class="o">=</span>/dev/vhost-vdpa-1,cache.direct<span class="o">=</span>on <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -blockdev node-name<span class="o">=</span>throttle0,driver<span class="o">=</span>throttle,file<span class="o">=</span>drive0,throttle-group<span class="o">=</span>limits0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -object throttle-group,id<span class="o">=</span>limits0,x-iops-total<span class="o">=</span><span class="m">2000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device virtio-blk-pci,drive<span class="o">=</span>throttle0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Alternatively, we can use the generic `vhost-vdpa-device-pci` to take</span>
</span></span><span class="line"><span class="cl"><span class="c1"># advantage of all the performance, but without having any QEMU block layer</span>
</span></span><span class="line"><span class="cl"><span class="c1"># features available</span>
</span></span><span class="line"><span class="cl">$ qemu-system-x86_64 -m 512M -smp <span class="m">2</span> -M q35,accel<span class="o">=</span>kvm,memory-backend<span class="o">=</span>mem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -object memory-backend-memfd,share<span class="o">=</span>on,id<span class="o">=</span>mem,size<span class="o">=</span><span class="s2">&#34;512M&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -device vhost-vdpa-device-pci,vhostdev<span class="o">=</span>/dev/vhost-vdpa-0
</span></span></code></pre></div>

        
          <div class="blog-tags">
            
              <a href="https://stefano-garzarella.github.io/tags/virtio/">virtio</a>&nbsp;
            
              <a href="https://stefano-garzarella.github.io/tags/vdpa/">vdpa</a>&nbsp;
            
              <a href="https://stefano-garzarella.github.io/tags/vduse/">vduse</a>&nbsp;
            
              <a href="https://stefano-garzarella.github.io/tags/linux/">linux</a>&nbsp;
            
              <a href="https://stefano-garzarella.github.io/tags/qemu/">qemu</a>&nbsp;
            
              <a href="https://stefano-garzarella.github.io/tags/conference/">conference</a>&nbsp;
            
              <a href="https://stefano-garzarella.github.io/tags/talk/">talk</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fstefano-garzarella.github.io%2fposts%2f2024-02-12-vdpa-blk%2f&amp;text=vDPA%3a%20support%20for%20block%20devices%20in%20Linux%20and%20QEMU&amp;via=sgarzarella" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fstefano-garzarella.github.io%2fposts%2f2024-02-12-vdpa-blk%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fstefano-garzarella.github.io%2fposts%2f2024-02-12-vdpa-blk%2f&amp;title=vDPA%3a%20support%20for%20block%20devices%20in%20Linux%20and%20QEMU" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fstefano-garzarella.github.io%2fposts%2f2024-02-12-vdpa-blk%2f&amp;title=vDPA%3a%20support%20for%20block%20devices%20in%20Linux%20and%20QEMU" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fstefano-garzarella.github.io%2fposts%2f2024-02-12-vdpa-blk%2f&amp;title=vDPA%3a%20support%20for%20block%20devices%20in%20Linux%20and%20QEMU" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fstefano-garzarella.github.io%2fposts%2f2024-02-12-vdpa-blk%2f&amp;description=vDPA%3a%20support%20for%20block%20devices%20in%20Linux%20and%20QEMU" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/posts/2021-01-22-socat-vsock/">SOCAT now supports AF_VSOCK</a></li>
                
                    <li><a href="/posts/2020-02-20-vsock-nested-vms-loopback/">AF_VSOCK: nested VMs and loopback support available</a></li>
                
                    <li><a href="/posts/2019-12-22-qemu-kernel-initrd-mmapped/">QEMU 4.2 mmap(2)s kernel and initrd</a></li>
                
                    <li><a href="/posts/2019-11-08-kvmforum-2019-vsock/">KVM Forum 2019: virtio-vsock in QEMU, Firecracker and Linux</a></li>
                
                    <li><a href="/posts/2019-08-24-qemu-linux-boot-time/">How to measure the boot time of a Linux VM with QEMU/KVM</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://stefano-garzarella.github.io/posts/2021-01-22-socat-vsock/" data-toggle="tooltip" data-placement="top" title="SOCAT now supports AF_VSOCK">&larr; Previous Post</a>
            </li>
          
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="mailto:sgarzare@redhat.com" title="Email me">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://github.com/stefano-garzarella" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://gitlab.com/sgarzarella" title="GitLab">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-gitlab fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://bitbucket.org/sgarzarella" title="Bitbucket">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-bitbucket fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://twitter.com/sgarzarella" title="Twitter">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://linkedin.com/in/stefanogarzarella" title="LinkedIn">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://stefano-garzarella.github.io/page/about">Stefano Garzarella</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://stefano-garzarella.github.io">sgarzare&#39;s blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.111.3</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://stefano-garzarella.github.io/js/main.js"></script>
<script src="https://stefano-garzarella.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://stefano-garzarella.github.io/js/load-photoswipe.js"></script>



<script>
  (function() {
    var cx = '011433376634952630999:louybk8offk';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>






<script type="text/javascript">
$(function(){
  $('#show-comments').on('click', function(){
    var disqus_shortname = 'stefano-garzarella-github-io';
      
    (function() {
      var disqus = document.createElement('script'); 
      disqus.type = 'text/javascript'; 
      disqus.async = true;
      disqus.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(disqus);
    })();
      
    $(this).hide(); 
    });
  });
      
</script>
<script id="dsq-count-scr" src="//stefano-garzarella-github-io.disqus.com/count.js" async></script>




    
  </body>
</html>

